<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет</title>
  <!-- Минимальный CSS для читаемости, вы можете заменить -->
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 20px; }
    .error { color: red; }
    input, textarea, button { margin: 5px; padding: 5px; }
    .recipe { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <!-- Контейнер для сообщений об ошибках -->
  <div id="error" class="error section"></div>

  <!-- Форма входа, отображается, если пользователь не авторизован -->
  <div id="login-section" class="section">
    <h2>Вход</h2>
    <!-- Форма отправляет данные на /api/auth/login -->
    <form id="login-form">
      <label>Email: <input type="email" id="email" required></label><br>
      <label>Пароль: <input type="password" id="password" required></label><br>
      <button type="submit">Войти</button>
    </form>
  </div>

  <!-- Секция личного кабинета, скрыта до входа -->
  <div id="cabinet-section" class="section" style="display: none;">
    <h2>Личный кабинет</h2>
    <button id="logout">Выйти</button>
    
    <!-- Список рецептов пользователя -->
    <div id="recipes-section" class="section">
      <h3>Ваши рецепты</h3>
      <div id="recipes-list"></div>
    </div>

    <!-- Форма добавления рецепта -->
    <div id="add-recipe-section" class="section">
      <h3>Добавить новый рецепт</h3>
      <form id="recipe-form">
        <label>Название: <input type="text" id="recipe-title" required></label><br>
        <label>Категория: <input type="text" id="recipe-category" required></label><br>
        <label>Описание: <textarea id="recipe-description" required></textarea></label><br>
        <label>Порции: <input type="number" id="recipe-servings" required></label><br>
        <label>Время приготовления (мин): <input type="number" id="recipe-cookingTime" required></label><br>
        <!-- Контейнер для динамических ингредиентов -->
        <div id="ingredients-container">
          <div class="ingredient">
            <label>Ингредиент: <input type="text" class="ingredient-name" required></label>
            <label>Количество (г): <input type="number" class="ingredient-quantity" required></label>
          </div>
        </div>
        <button type="button" id="add-ingredient">Добавить ингредиент</button><br>
        <label>Изображение (URL): <input type="text" id="recipe-image"></label><br>
        <!-- Контейнер для динамических шагов -->
        <div id="steps-container">
          <div class="step">
            <label>Шаг: <input type="text" class="step-description" required></label>
            <label>Изображение шага (URL): <input type="text" class="step-image"></label>
          </div>
        </div>
        <button type="button" id="add-step">Добавить шаг</button><br>
        <button type="submit">Добавить рецепт</button>
      </form>
    </div>
  </div>

  <!-- JavaScript для обработки логики -->
  <script>
    // Переменные для хранения токена и ID пользователя
    let token = localStorage.getItem('token') || '';
    let userId = localStorage.getItem('userId') || '6836fa976a89ea9016e2c937'; // Замените на реальный ID

    // Элементы DOM
    const loginSection = document.getElementById('login-section');
    const cabinetSection = document.getElementById('cabinet-section');
    const errorDiv = document.getElementById('error');
    const loginForm = document.getElementById('login-form');
    const logoutButton = document.getElementById('logout');
    const recipeForm = document.getElementById('recipe-form');
    const recipesList = document.getElementById('recipes-list');
    const addIngredientButton = document.getElementById('add-ingredient');
    const addStepButton = document.getElementById('add-step');
    const ingredientsContainer = document.getElementById('ingredients-container');
    const stepsContainer = document.getElementById('steps-container');

    // Проверка авторизации при загрузке страницы
    if (token) {
      // Если токен есть, скрываем форму входа и показываем кабинет
      loginSection.style.display = 'none';
      cabinetSection.style.display = 'block';
      // Загружаем рецепты пользователя
      fetchRecipes();
    }

    // Обработчик входа
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch('http://localhost:5000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (data.token) {
            token = data.token;
            userId = data.userId; // Используем userId из ответа
            localStorage.setItem('token', token);
            localStorage.setItem('userId', userId);
            loginSection.style.display = 'none';
            cabinetSection.style.display = 'block';
            errorDiv.textContent = '';
            fetchRecipes();
            } else {
            errorDiv.textContent = data.message || 'Ошибка входа';
            }
        } catch (err) {
            console.error('Fetch Error:', err);
            errorDiv.textContent = 'Ошибка соединения с сервером: ' + err.message;
        }
    });

    // Обработчик выхода
    logoutButton.addEventListener('click', () => {
      // Очищаем токен и userId
      token = '';
      userId = '';
      localStorage.removeItem('token');
      localStorage.removeItem('userId');
      // Показываем форму входа, скрываем кабинет
      loginSection.style.display = 'block';
      cabinetSection.style.display = 'none';
      recipesList.innerHTML = '';
      errorDiv.textContent = '';
    });

    // Функция загрузки рецептов
    async function fetchRecipes() {
      try {
        // Отправляем запрос на /api/users/:id/recipes
        const response = await fetch(`http://localhost:5000/api/users/${userId}/recipes`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const recipes = await response.json();

        if (Array.isArray(recipes)) {
          // Очищаем список рецептов
          recipesList.innerHTML = '';
          if (recipes.length === 0) {
            recipesList.innerHTML = '<p>У вас пока нет рецептов</p>';
          } else {
            // Отображаем каждый рецепт
            recipes.forEach(recipe => {
              const recipeDiv = document.createElement('div');
              recipeDiv.className = 'recipe';
              recipeDiv.innerHTML = `
                <h4>${recipe.title}</h4>
                <p>Категория: ${recipe.category}</p>
                <p>Описание: ${recipe.description}</p>
                ${recipe.image ? `<img src="${recipe.image}" alt="${recipe.title}" style="max-width: 200px;">` : ''}
              `;
              recipesList.appendChild(recipeDiv);
            });
          }
        } else {
          errorDiv.textContent = recipes.message || 'Ошибка загрузки рецептов';
        }
      } catch (err) {
        errorDiv.textContent = 'Ошибка соединения с сервером';
      }
    }

    // Обработчик добавления ингредиента
    addIngredientButton.addEventListener('click', () => {
      // Создаём новый блок для ингредиента
      const ingredientDiv = document.createElement('div');
      ingredientDiv.className = 'ingredient';
      ingredientDiv.innerHTML = `
        <label>Ингредиент: <input type="text" class="ingredient-name" required></label>
        <label>Количество (г): <input type="number" class="ingredient-quantity" required></label>
      `;
      ingredientsContainer.appendChild(ingredientDiv);
    });

    // Обработчик добавления шага
    addStepButton.addEventListener('click', () => {
      // Создаём новый блок для шага
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step';
      stepDiv.innerHTML = `
        <label>Шаг: <input type="text" class="step-description" required></label>
        <label>Изображение шага (URL): <input type="text" class="step-image"></label>
      `;
      stepsContainer.appendChild(stepDiv);
    });

    // Обработчик добавления рецепта
    recipeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Собираем данные формы
      const recipe = {
        title: document.getElementById('recipe-title').value,
        category: document.getElementById('recipe-category').value,
        description: document.getElementById('recipe-description').value,
        servings: parseInt(document.getElementById('recipe-servings').value),
        cookingTime: parseInt(document.getElementById('recipe-cookingTime').value),
        ingredients: [],
        ingredientQuantities: [],
        image: document.getElementById('recipe-image').value,
        steps: []
      };

      // Собираем ингредиенты
      const ingredientDivs = ingredientsContainer.getElementsByClassName('ingredient');
      for (let div of ingredientDivs) {
        const name = div.querySelector('.ingredient-name').value;
        const quantity = parseInt(div.querySelector('.ingredient-quantity').value);
        recipe.ingredients.push(name);
        recipe.ingredientQuantities.push(quantity);
      }

      // Собираем шаги
      const stepDivs = stepsContainer.getElementsByClassName('step');
      for (let div of stepDivs) {
        const description = div.querySelector('.step-description').value;
        const image = div.querySelector('.step-image').value;
        recipe.steps.push({ description, image });
      }

      try {
        // Отправляем запрос на /api/recipes
        const response = await fetch('http://localhost:5000/api/recipes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(recipe)
        });
        const data = await response.json();
        console.log('Response:', data); // Добавляем отладку
        if (data._id) {
          // Очищаем форму
          recipeForm.reset();
          ingredientsContainer.innerHTML = `
            <div class="ingredient">
              <label>Ингредиент: <input type="text" class="ingredient-name" required></label>
              <label>Количество (г): <input type="number" class="ingredient-quantity" required></label>
            </div>
          `;
          stepsContainer.innerHTML = `
            <div class="step">
              <label>Шаг: <input type="text" class="step-description" required></label>
              <label>Изображение шага (URL): <input type="text" class="step-image"></label>
            </div>
          `;
          errorDiv.textContent = 'Рецепт добавлен!';
          console.log('Отправляемый рецепт:', recipe);
          // Обновляем список рецептов
          fetchRecipes();
        } else {
          errorDiv.textContent = data.message || 'Ошибка добавления рецепта';
        }
      } catch (err) {
        console.error('Fetch Error:', err);
        errorDiv.textContent = 'Ошибка соединения с сервером';
      }
    });
  </script>
</body>
</html>